<!DOCTYPE html>
<html lang="en" xmlns:fb="https://www.facebook.com/2008/fbml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Meme Captain meme generator</title>
<style type="text/css">
body {
  font-family : verdana, helvetica, arial, sans-serif;
}

#sourceImages {
  background-color : #eee;
  border : 1px solid #ccc;
  padding : 0em 1em 0.5em 1em;
  margin : 1em 0em 1em 0em;
}

img.thumb {
  margin : 2px;
}

#heading {
  font-size : 1em;
  font-weight : normal;
}
</style>
</head>

<body>

<h1 id="heading"><a href="<%= h @root_url %>">Meme Captain</a> - make memes with images and text</h1>

<div id="img"></div>

<form action="" method="get">

<table>

<tr>
<td><label for="u">Source image URL: </label></td>
<td><input type="text" id="u" name="u" size="64" value="<%= h @u %>" tabindex="1" /></td>
</tr>

<tr>
<td><label for="t1">Text 1: </label></td>
<td>
<input type="text" id="t1" name="t1" size="64" value="<%= h @t1 %>" tabindex="2" />
</td>
<td><label for="t1x">X: </label></td>
<td>
<input type="text" id="t1x" name="t1x" size="4" value="<%= h @t1x %>" tabindex="4" />
</td>
<td><label for="t1y">Y: </label></td>
<td>
<input type="text" id="t1y" name="t1y" size="4" value="<%= h @t1y %>" tabindex="5" />
</td>
<td><label for="t1w">Width: </label></td>
<td>
<input type="text" id="t1w" name="t1w" size="4" value="<%= h @t1w %>" tabindex="6" />
</td>
<td><label for="t1h">Height: </label></td>
<td>
<input type="text" id="t1h" name="t1h" size="4" value="<%= h @t1h %>" tabindex="7" />
</td>
</tr>

<tr>
<td><label for="t2">Text 2: </label></td>
<td>
<input type="text" id="t2" name="t2" size="64" value="<%= h @t2 %>" tabindex="3" />
</td>
<td><label for="t2x">X: </label></td>
<td>
<input type="text" id="t2x" name="t2x" size="4" value="<%= h @t2x %>" tabindex="8" />
</td>
<td><label for="t2y">Y: </label></td>
<td>
<input type="text" id="t2y" name="t2y" size="4" value="<%= h @t2y %>" tabindex="9" />
</td>
<td><label for="t2w">Width: </label></td>
<td>
<input type="text" id="t2w" name="t2w" size="4" value="<%= h @t2w %>" tabindex="10" />
</td>
<td><label for="t2h">Height: </label></td>
<td>
<input type="text" id="t2h" name="t2h" size="4" value="<%= h @t2h %>" tabindex="11" />
</td>
</tr>

<tr>
<td></td>
<td>
<input type="button" id="positionTextButton" value="Position Text" />
<input type="submit" value="Create Image" /></td>
</tr>

</table>

</form>

<div id="sourceImages">

<p>Locally hosted source images or search for source images (click thumbnail to use):</p>

<div id="imageSearchResults"></div>

<form action="" method="get">
<input type="text" id="imageSearch" />
<input type="button" id="imageSearchButton" value="Image Search" /> powered by Bing and Google
</form>

</div>

<p>
Contact: Matthew M. Boedicker <a href="mailto:matthewm@boedicker.org">matthewm@boedicker.org</a> |
<a href="http://twitter.com/memecaptain">@memecaptain</a>
</p>

<p><a href="https://github.com/mmb/meme_captain">source code and API</a></p>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="js/fabric.min.js"></script>
<script>
function showBingImages(resp) {
    var div = $('#imageSearchResults'),
        searchResponse = resp.SearchResponse,
        image = searchResponse.Image;

    if (image.Total > 0) {
        $.each(image.Results, function (i, img) {
            div.append($('<img />').attr('src', img.Thumbnail.Url).click(
                function () { $('#u').val(img.MediaUrl); }
            ));
        });
    } else {
        div.append($('<p />').append(
            'No Bing results for "' + searchResponse.Query.SearchTerms + '".'));
    }
}

function showGoogleImages(resp) {
    var div = $('#imageSearchResults'),
        searchResults = resp.responseData.results;

    if (searchResults.length > 0) {
        $.each(searchResults, function (i, img) {
            div.append($('<img />').attr('src', img.tbUrl).click(
                function () { $('#u').val(img.url); }
            ));
        });
    } else {
        div.append($('<p />').append('No Google results.'));
    }
}

function imageSearch() {
    var imageSearch = $('#imageSearch'),
        imageSearchVal = imageSearch.val();

    if (imageSearchVal.match(/[^\s]/)) {
        imageSearch.val('');
        $('#imageSearchResults').empty();

        $.ajax({
            type : 'GET',
            url : 'http://api.bing.net/json.aspx',
            data : {
                AppId : 'A120380275E87F0071F163210211F0592D0E964C',
                Query : imageSearchVal + ' imagesize:Medium',
                Sources : 'Image',
                Version : '2.0',
                Market : 'en-us',
                'Image.Count' : 5,
                'Image.Offset' : 0,
                JsonType : 'callback'
            },
            dataType : 'jsonp',
            jsonpCallback : 'showBingImages',
            jsonp : 'JsonCallback'
        });

        $.ajax({
            type : 'GET',
            url : 'http://ajax.googleapis.com/ajax/services/search/images',
            data : {
                imgsz : 'large',
                key : 'ABQIAAAA-E0uJIHoMJX6M6atCgYANRS1DzXPXMqKnKNRJm2Z_PRWxvtqGBSOvBqyXOwxGZU5jLxExg_5ym69rw',
                q : imageSearchVal,
                rsz : '5',
                v : '1.0',
            },
            dataType : 'jsonp',
            jsonpCallback : 'showGoogleImages',
        });
    }
}

function loadSourceImages() {
    $.get('source_images.json', function(data) {
        var pos = 0,
            div = $('#imageSearchResults');

        $.each(data.images, function (i, img) {
            div.before($('<img />').attr('src', '1.gif').addClass('thumb').css({
                'background-image' : 'url(' + data.thumbSpritesUrl + ')',
                'background-position' : pos + 'px 0px',
                height : data.thumbHeight,
                width : img.thumbWidth + 'px',
            }).click(function() {
                $('#u').val(img.url);
            }));

            pos -= img.thumbWidth;
        });
    });
}

function positionText() {
    var imageUrl = $('#u').val(),

        canvas,
        canvasHeight,
        canvasWidth,

        rect1,
        rect2;

    if (imageUrl.length > 0) {
        $('#img').empty().append($('<canvas />').attr({
            id : 'positionTextCanvas'
        }));

        canvas = new fabric.Canvas('positionTextCanvas');

        canvas.setBackgroundImage(imageUrl, function () {
            canvas.setWidth(canvas.backgroundImage.width);
            canvas.setHeight(canvas.backgroundImage.height);

            canvas.renderAll.bind(canvas);

            canvasWidth = canvas.getWidth(),
            canvasHeight = canvas.getHeight(),
            textWidth = 0.9 * canvasWidth,
            textHeight = .25 * canvasHeight;

            rect1 = new fabric.Rect({
                top  : textHeight / 2.0,
                left : ((canvasWidth - textWidth) / 2.0) + (textWidth / 2.0),
                width : textWidth,
                height: textHeight,
                fill: 'red'
            });

            rect1.name = '1';
            rect1.set('lockRotation', true);

            canvas.add(rect1);

            rect2 = new fabric.Rect({
                top : canvasHeight - (textHeight / 2.0),
                left : ((canvasWidth - textWidth) / 2.0) + (textWidth / 2.0),
                width : textWidth,
                height : textHeight,
                fill: 'red'
            });

            rect2.name = '2';
            rect2.set('lockRotation', true);

            canvas.add(rect2);

            canvas.observe('object:modified', function (o) {
                var target = o.memo.target;

                $('#t' + target.name + 'x').val(
                    Math.round(target.getLeft() - (target.getWidth() / 2)));
                $('#t' + target.name + 'y').val(
                    Math.round(target.getTop() - (target.getHeight() / 2)));
                $('#t' + target.name + 'w').val(Math.round(target.getWidth()));
                $('#t' + target.name + 'h').val(Math.round(target.getHeight()));
            });

            canvas.fire('object:modified', { target : rect1 });
            canvas.fire('object:modified', { target : rect2 });
        });
    }
}

$(function () {
    var image,
        imgDiv;

    loadSourceImages();

    if (window.location.search.match(/u=[^&$]/)) {
        $('#tt').focus();

        imgDiv = $('#img');

        imgDiv.append($('<p />').append('Creating image ...'));

        $.get('/g' + window.location.search, function (data) {
            var img = $('<img />').attr('src', data.permUrl),
            imgLink = $('<a />').attr('href', data.permUrl).append(data.permUrl),
            templateLink = $('<a />').attr('href', data.templateUrl).append(
                data.templateUrl),
            tweetLink = $('<a />').attr({
                href : 'http://twitter.com/share',
                'class' : 'twitter-share-button',
                'data-count' : 'none',
                'data-text' : ' ',
                'data-url' : data.permUrl
                }).append('Tweet');

            imgDiv.empty().append(
                img).append(
                $('<p />').append('Image: ').append(imgLink)).append(
                $('<p />').append('Template: ').append(
                    templateLink)).append(
                $('<p />').append(tweetLink).append($('<script />').attr('src',
                    'http://platform.twitter.com/widgets.js')));

            // Facebook like
            imgDiv.append(
                $('<div />').attr('id', 'fb-root')).append(
                $('<fb:like />').attr({
                    href : data.permUrl,
                    send : 'true',
                    width : '450',
                    show_faces : 'true',
                    font : ''
                    }));

            window.fbAsyncInit = function () {
                FB.init({
                    appId : '108445492580525',
                    status : true,
                    cookie : true,
                    xfbml : true
                    });
                };

            imgDiv.append($('<script />').attr({
                src : 'http://connect.facebook.net/en_US/all.js'}));
        }).error(function (j) {
          imgDiv.empty().append($('<p />').text(j.responseText));
        });
    } else {
        $('#u').focus();
    }

    $('#imageSearch').keypress(function (event) {
        if (event.which === 13) {
            event.preventDefault();
            imageSearch();
        }
    });

    $('#imageSearchButton').click(imageSearch);

    $('#positionTextButton').click(positionText);
});
</script>

</body>

</html>
